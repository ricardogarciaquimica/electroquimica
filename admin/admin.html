<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin</title>
<script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js'></script>
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script type='text/javascript' src='../js/behavior.js'></script>
<script type='text/javascript' src='../js/content.js'></script>
<script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js'></script>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="http://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />
<script src="https://fastcdn.org/FileSaver.js/1.1.20151003/FileSaver.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<script>
</script>
<body style="background-color: #EAF2F8">
	<div style="margin:0px; padding:0px">
		<div style="background-color: #A9CCE3; margin=0px">
			<h1>Panel de Administración</h1>
		</div>
		<div>
			<h3>Títulos</h3>
			<p>Título: <input id="headerTitle" style="margin-left: 10px; width: 80%" type="text" /></p>
			<p>Sub-Título: <input id="headerSubTitle" style="margin-left: 10px; width: 80%" type="text" /></p>
			<p>Título-Indice: <input id="indexTitle"  style="margin-left: 10px; width: 80%" type="text" /></p>
			<h3>Footer</h3>
			<span>Texto:</span><input id="footerText" style="margin-left: 10px; width: 80%" type="text" />
		</div>
		<div>
			<h3>Menú</h3>
			<div id="jsGridMenu" style="background-color:white"></div>
		</div>
		<div>
			<h3>Índice</h3>
			<div id="jsGridIndice" style="background-color:white"></div>
		</div>
		<div>
			<h3>Relación de contenido</h3>
			<div id="jsGridRelacion" style="background-color:white"></div>
		</div>
		<div>
			<h3>Edición de Contenido</h3>
			<div style="background-color:white">
				<div id="toolbar" ></div>
				<div id="editor"  style="height: 500px"></div>
			</div>
		</div>
		<div style="margin:30px">
			<button id="btnGuardar">Guardar</button>
		</div>
	<div>
</body>
<script>

	$("#imgUrl").val(content.imgUrl);
	$("#headerTitle").val(content.headerTitle);
	$("#headerSubTitle").val(content.headerSubTitle);
	$("#footerText").val(content.footerText);
	$("#indexTitle").val(content.indexTitle);

	var toolbarOptions = [[{'font': [] }, {'size': [] }],
                      ['bold', 'italic', 'underline', 'strike'],
                      ['color', 'background'],
                      [{'script': 'sub'}, {'script': 'super'}],
                      [{'header': 1}, {'header': 2}, 'blockquote', 'code-block'],
                      [{'list': 'ordered'}, {'list': 'bullet'}, {'indent': '-1'}, {'indent': '+1'}],
                      [{'direction': 'rtl'}, {'align': [] }],
                      ['link', 'image', 'video'],
                      ['clean']];
	
	var options = {
	  debug: 'info',
	  modules: {
		toolbar: toolbarOptions
	  },
	  theme: 'snow'
	};

   var quill = new Quill('#editor', options);
   
   //------------------------------------------------------------------------
   
    $("#jsGridMenu").jsGrid({
        width: "100%",
        height: "400px",
 
        inserting: true,
        editing: true,
        sorting: true,
        paging: true,
 
        data: window.content.navBar.getItems(),
 
        fields: [
            { name: "id", type: "number", width: 10, editing: false },
            { name: "text", type: "text", width: 100, validate: "required"  },
			{ type: "control" }
        ],
		onItemDeleting: function(args) {
            var pages = window.content.contentPages.getPages();
			var item = args.item;
			var found = pages.find(i => i.navBarId === item.id);
		   
		    if(found){
				alert("No puede eliminarse un item ya que posee una relacion de contenido");
				args.cancel = true;
				return;
			}
			
			$("#jsGridRelacion").jsGrid("render");
		},
		onItemInserting: function(args) {
			var pages = window.content.navBar.getItems();
			var item = args.item;
			var found = pages.find(i => i.id === item.id);
			 if(found){
				alert("Id duplicado. Ingrese otro id.");
				args.cancel = true;
				return;
			}
		}
    });
	
	$("#jsGridIndice").jsGrid({
        width: "100%",
        height: "400px",
 
        inserting: true,
        editing: true,
        sorting: true,
        paging: true,
 
        data: window.content.index.getItems(),
 
        fields: [
            { name: "id", type: "number", width: 10, editing: false },
            { name: "text", type: "text", width: 100, validate: "required"  },
			/*{ name: "Item Menu", type: "select", width: 100, validate: "required", items: window.content.navBar.getItems(), valueField: "id", textField: "text"},*/
			{ type: "control" } ],
	    onItemDeleting: function(args) {
            var pages = window.content.contentPages.getPages();
			var item = args.item;
			var found = pages.find(i => i.indexId === item.id);
		   
		    if(found){
				alert("No puede eliminarse un item ya que posee una relacion de contenido");
				args.cancel = true;
				return;
			}
			
			$("#jsGridRelacion").jsGrid("reset");
		},
		onItemInserting: function(args) {
			var pages = window.content.index.getItems();
			var item = args.item;
			var found = pages.find(i => i.id === item.id);
			 if(found){
				alert("Id duplicado. Ingrese otro id.");
				args.cancel = true;
				return;
			}
			$("#jsGridRelacion").jsGrid("reset");
		}
    });
	
	$("#jsGridRelacion").jsGrid({
        width: "100%",
        height: "400px",
 
        inserting: true,
        editing: true,
        sorting: true,
        paging: true,
 
        data: window.content.contentPages.getPages(),
 
        fields: [
		    { name: "navBarId", type: "select", width: 50, validate: "required", items: window.content.navBar.getItems(), valueField: "id", textField: "text"},
			{ name: "indexId", type: "select", width: 50, validate: "required", items: window.content.index.getItems(), valueField: "id", textField: "text"},
            { name: "popUp", type: "checkbox", width: 15, validate: "required"  },
			{ name: "notes", type: "text", width: 200  },
			{ name: "htmlPage", visible: false  },
			{ type: "control" } ],
			
		onItemInserted: function(args) {
			var item = args.item;
			var htmlPage = $("#editor .ql-editor").html();
			
			if(htmlPage && htmlPage != '<p><br></p>')
				item.htmlPage = htmlPage;
			else
				item.htmlPage =  "<p>Página sin contenido.</p>";
				
			if(item.notes == null)
				item.notes = "Sin notas.";
			
		},
		onItemUpdated: function(args){
			var item = args.item;
			var htmlPage = $("#editor .ql-editor").html();
			
			if(htmlPage && htmlPage != '<p><br></p>')
				item.htmlPage = htmlPage;
			else
				item.htmlPage =  "<p>Página sin contenido.</p>";
				
			if(item.notes == null)
				item.notes = "Sin notas.";
		},
	    onItemInserting: function(args) {
			var item = args.item;
			var foundDuplicated = this.data.find(i => i.navBarId === item.navBarId && i.indexId == item.indexId);
			quill.root.innerHTML = '';
			
			if(foundDuplicated){
				alert("La combinación entre menu e indice ya existe");
				args.cancel = true;
				return;
			}
			
			if(item.notes == null)
				item.notes = '';
			
			$("#jsGridRelacion").jsGrid("reset");
		},
		rowClick: function(args) {
			quill.root.innerHTML = args.item.htmlPage;
		}
    });
	
   $("#btnGuardar").on("click",() => {
		
		var cnt = window.content;
		cnt.imgUrl= $("#imgUrl").val();
		cnt.headerTitle= $("#headerTitle").val();
		cnt.headerSubTitle= $("#headerSubTitle").val();
		cnt.footerText= $("#footerText").val();
		cnt.indexTitle= $("#indexTitle").val();
		
		var jsonContent= 'window.content = new content(); window.content.load(eval('+JSON.stringify(cnt)+'));';
		var blob = new Blob([jsonContent], {type: "text/html;charset=utf-8"});
		saveAs(blob, "content.js");
		
		/*
		var blob = new Blob([$("#editor .ql-editor").html()], {type: "text/html;charset=utf-8"});
		saveAs(blob, "test.html");
		*/
   });
   
 </script>
</html>